<?xml version="1.0" encoding="ISO-8859-1"?>
<scene_renderer_commands>
	<!--pre_render-->
	<begin_scene />
	<clear_scene color="true" depth="true" stencil="true" />
	<enable_z_write />
	<enable_z_test />
	<setup_matrices />
	
	<!-- Generate Shadow Maps -->
	<set_pool_renderable_objects_technique pool="Basic_Build_Shadow_Map" />
	<generate_shadow_maps />
	
	<set_render_target name="deferred_multiple_render_target">
		<dynamic_texture stage_id="0" name="DiffuseMapTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		<dynamic_texture stage_id="1" name="NormalMapTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
		<dynamic_texture stage_id="2" name="DepthMapTexture" texture_width_as_frame_buffer="true" format_type="R32F"/>
		<dynamic_texture stage_id="3" name="LightMapTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
	</set_render_target>
	
	<clear_scene color="true" depth="true" stencil="true" />
	
	<set_pool_renderable_objects_technique pool="Deferred_Shading" />
	
	<render_scene layer="solid" active="true" />
	
	<unset_render_target render_target="deferred_multiple_render_target"/>
	
	<set_render_target name="deferred_lights">
		<dynamic_texture stage_id="0" name="LightMapTexture" texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
	</set_render_target>
	
	<render_deferred_shading>
		<texture stage_id="0" file="NormalMapTexture"/>
		<texture stage_id="1" file="DepthMapTexture"/>
	</render_deferred_shading>
	
	<unset_render_target render_target="deferred_lights"/>
		
	<set_pool_renderable_objects_technique pool="Deferred_Shading_Combine" />
	<render_draw_quad name="Deferred_Lighting_Combine">
		<texture stage_id="0" file="DiffuseMapTexture"/>
		<texture stage_id="1" file="LightMapTexture"/>
	</render_draw_quad><!-- -->
		
	<capture_frame_buffer>
		<dynamic_texture stage_id="0" name="FrameBufferAfterDeferredShading"
			texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
	</capture_frame_buffer>
	
	<!-- SSAA -->
	<set_pool_renderable_objects_technique pool="ssaa_pool" />
	<render_draw_quad name="SSAA_Quad">
		<texture stage_id="0" file="FrameBufferAfterDeferredShading"/>
		<texture stage_id="1" file="NormalMapTexture"/>
	</render_draw_quad>
	<!-- SSAA -->
	
	<!-- Color Grading -->
	<set_pool_renderable_objects_technique pool="color_grading_pool" />
	<render_draw_quad name="color_grading_quad">
		<texture stage_id="0" file="FrameBufferAfterDeferredShading"/>
	</render_draw_quad>
	<!-- Color Grading -->
	
	<!-- ZBlur -->
	<capture_frame_buffer>
		<dynamic_texture stage_id="0" name="FrameBufferCompleteTexture"
			texture_width_as_frame_buffer="true" format_type="A8R8G8B8"/>
	</capture_frame_buffer>
	<set_pool_renderable_objects_technique pool="zblur_pool" />
	<render_draw_quad name="ZBlur_Quad">
		<texture stage_id="0" file="FrameBufferCompleteTexture"/>
		<texture stage_id="1" file="DepthMapTexture"/>
	</render_draw_quad>
	<!-- ZBlur -->
	
	<!-- TEST ONLY  -->
	<!--<set_pool_renderable_objects_technique pool="dummy_manager" />
	<render_draw_quad name="TEST">
		<texture stage_id="0" file="FrameBufferAfterDeferredShading"/>
	</render_draw_quad>-->
	
	<!-- TEST ONLY 
	<set_pool_renderable_objects_technique pool="dummy_manager" />
	<render_draw_quad name="TEST">
		<texture stage_id="0" file="Spot001_dynamic"/>
	</render_draw_quad> -->
	
	<!--Debug-->
	<render_debug_info grid="true" axis="true" />
	<render_debug_lights active="true" />
	<end_scene />
	<present />
</scene_renderer_commands>